<!-- è®°å½•é¡µé¢ - çŒ«çŒ«ä½“é‡ + å§¨å¦ˆè®°å½• -->
<view class="container">
  <!-- è‡ªå®šä¹‰å¯¼èˆªæ  -->
  <view class="custom-navbar" style="padding-top: {{statusBarHeight}}px">
    <view class="navbar-content">
      <text class="navbar-title">æˆ‘çš„è®°å½•</text>
    </view>
  </view>
  <view class="navbar-placeholder" style="height: {{navbarHeight}}px"></view>

  <!-- é¡¶éƒ¨Tabåˆ‡æ¢ -->
  <view class="top-tabs">
    <view class="top-tab {{currentTab === 'weight' ? 'top-tab-active' : ''}}" bindtap="switchTab" data-tab="weight">
      <text class="top-tab-icon">ğŸ±</text>
      <text class="top-tab-text">çŒ«çŒ«ä½“é‡</text>
    </view>
    <view class="top-tab {{currentTab === 'period' ? 'top-tab-active' : ''}}" bindtap="switchTab" data-tab="period">
      <text class="top-tab-icon">ğŸŒ¸</text>
      <text class="top-tab-text">å§¨å¦ˆè®°å½•</text>
    </view>
  </view>

  <!-- ==================== ä½“é‡å†…å®¹ ==================== -->
  <view class="tab-content" wx:if="{{currentTab === 'weight'}}">
    <!-- å® ç‰©å¡ç‰‡ -->
    <view class="pet-cards">
      <view 
        class="pet-card" 
        wx:for="{{personList}}" 
        wx:key="*this" 
        wx:for-item="person"
        style="--accent-color: {{personConfig[person].color}}"
      >
        <view class="pet-card-accent"></view>
        <view class="pet-avatar">
          <text class="pet-emoji">{{personConfig[person].emoji}}</text>
        </view>
        <view class="pet-info">
          <text class="pet-name">{{person}}</text>
          <view class="pet-weight-wrap">
            <text class="pet-weight">{{latestWeights[person] || '--'}}</text>
            <text class="pet-unit">æ–¤</text>
          </view>
        </view>
      </view>
    </view>

    <!-- å›¾è¡¨åŒºåŸŸ -->
    <view class="section-card">
      <view class="section-header">
        <view class="section-title-wrap">
          <view class="section-icon">ğŸ“ˆ</view>
          <text class="section-title">ä½“é‡è¶‹åŠ¿</text>
        </view>
      </view>
      
      <!-- æ—¶é—´èŒƒå›´ç­›é€‰ -->
      <view class="filter-tabs">
        <view class="filter-tab {{timeRange === 'week' ? 'filter-tab-active' : ''}}" 
              bindtap="onTimeRangeChange" data-range="week">è¿‘7å¤©</view>
        <view class="filter-tab {{timeRange === 'month' ? 'filter-tab-active' : ''}}" 
              bindtap="onTimeRangeChange" data-range="month">è¿‘30å¤©</view>
        <view class="filter-tab {{timeRange === '3month' ? 'filter-tab-active' : ''}}" 
              bindtap="onTimeRangeChange" data-range="3month">è¿‘3æœˆ</view>
        <view class="filter-tab {{timeRange === 'all' ? 'filter-tab-active' : ''}}" 
              bindtap="onTimeRangeChange" data-range="all">å…¨éƒ¨</view>
      </view>

      <!-- Canvas æŠ˜çº¿å›¾ -->
      <view class="chart-wrapper">
        <view class="chart-container" wx:if="{{!showWeightForm}}">
          <canvas type="2d" id="weight-canvas" class="weight-canvas"></canvas>
        </view>
        <view class="chart-container chart-placeholder" wx:else>
          <text class="placeholder-icon">ğŸ“Š</text>
          <text class="placeholder-text">ç¼–è¾‘ä¸­...</text>
        </view>
      </view>

      <!-- å›¾ä¾‹ -->
      <view class="chart-legend">
        <view class="legend-item" wx:for="{{personList}}" wx:key="*this" wx:for-item="person">
          <view class="legend-dot" style="background: {{personConfig[person].color}}"></view>
          <text class="legend-text">{{person}}</text>
        </view>
      </view>
    </view>

    <!-- è®°å½•åˆ—è¡¨ -->
    <view class="section-card">
      <view class="section-header">
        <view class="section-title-wrap">
          <view class="section-icon">ğŸ“‹</view>
          <text class="section-title">è®°å½•æ˜ç»†</text>
        </view>
        <view class="section-badge" wx:if="{{weightRecords.length}}">{{weightRecords.length}}æ¡</view>
      </view>

      <view class="loading-container" wx:if="{{loadingWeight}}">
        <view class="loading-spinner"></view>
        <text class="loading-text">åŠ è½½ä¸­...</text>
      </view>

      <view class="records-container" wx:elif="{{weightRecords.length}}">
        <view class="person-group" wx:for="{{personList}}" wx:key="*this" wx:for-item="person" wx:if="{{groupedRecords[person].length}}">
          <view class="person-header">
            <view class="person-info">
              <text class="person-emoji">{{personConfig[person].emoji}}</text>
              <text class="person-name" style="color: {{personConfig[person].color}}">{{person}}</text>
            </view>
            <view class="person-badge">{{groupedRecords[person].length}}æ¡</view>
          </view>
          
          <view class="record-grid">
            <view 
              class="record-card"
              wx:for="{{groupedRecords[person]}}" 
              wx:key="id"
              wx:for-item="record"
              data-id="{{record.id}}"
              data-person="{{person}}"
              bindtap="onWeightRecordTap"
              bindlongpress="onWeightRecordLongPress"
            >
              <text class="record-date">{{record.recordDateFormatted}}</text>
              <view class="record-value" style="color: {{personConfig[person].color}}">
                <text class="record-weight">{{record.weight}}</text>
                <text class="record-unit">æ–¤</text>
              </view>
            </view>
          </view>
        </view>
      </view>

      <view class="empty-state" wx:if="{{!loadingWeight && !weightRecords.length}}">
        <text class="empty-icon">âš–ï¸</text>
        <text class="empty-title">è¿˜æ²¡æœ‰ä½“é‡è®°å½•</text>
        <text class="empty-text">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ï¼Œå¼€å§‹è®°å½•å®è´çš„ä½“é‡</text>
        <view class="empty-btn" bindtap="showAddWeightForm">+ æ·»åŠ è®°å½•</view>
      </view>
    </view>

    <!-- æ‚¬æµ®æ·»åŠ æŒ‰é’® -->
    <view class="fab-btn" bindtap="showAddWeightForm" wx:if="{{!showWeightForm}}">
      <text class="fab-icon">+</text>
    </view>

    <!-- åº•éƒ¨æ¶ˆæ¯æ¨é€å…¥å£ -->
    <view class="footer-link-wrap">
      <navigator url="/pages/openid/openid" class="footer-link">
        <text class="footer-link-icon">ğŸ””</text>
        <text class="footer-link-text">æ¶ˆæ¯æ¨é€è®¾ç½®</text>
        <text class="footer-link-arrow">â€º</text>
      </navigator>
    </view>
  </view>

  <!-- ==================== å§¨å¦ˆå†…å®¹ ==================== -->
  <view class="tab-content" wx:if="{{currentTab === 'period'}}">
    <!-- çŠ¶æ€å¡ç‰‡ -->
    <view class="period-status-card" wx:if="{{periodStats}}">
      <view class="period-status-icon">ğŸŒ¸</view>
      <view class="period-status-info">
        <view class="period-status-main" wx:if="{{periodStats.status === 'none'}}">
          <text class="period-status-text">æš‚æ— è®°å½•</text>
          <text class="period-status-hint">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹è®°å½•</text>
        </view>
        <view class="period-status-main" wx:elif="{{periodStats.status === 'in-period'}}">
          <text class="period-status-text">ç»æœŸç¬¬ {{periodDays}} å¤©</text>
          <text class="period-status-hint">è®°å¾—æ³¨æ„ä¿æš–å“¦ ğŸ’•</text>
        </view>
        <view class="period-status-main" wx:else>
          <text class="period-status-text" wx:if="{{periodStats.daysUntilNextPeriod > 0}}">è·ä¸‹æ¬¡å§¨å¦ˆè¿˜æœ‰ {{periodStats.daysUntilNextPeriod}} å¤©
          </text>
          <text class="period-status-text" wx:elif="{{periodStats.daysUntilNextPeriod === 0}}">
            é¢„è®¡ä»Šå¤©å¼€å§‹
          </text>
          <text class="period-status-text" wx:else>
            å·²è¶…å‡ºé¢„è®¡ {{0 - periodStats.daysUntilNextPeriod}} å¤©
          </text>
          <text class="period-status-hint">å¹³å‡å‘¨æœŸ {{periodStats.averageCycleDays}} å¤©</text>
        </view>
      </view>
    </view>

    <!-- æ—¥å†åŒºåŸŸ -->
    <view class="calendar-card">
      <!-- æœˆä»½å¯¼èˆª -->
      <view class="calendar-header">
        <view class="month-nav" bindtap="prevMonth">
          <text class="nav-arrow">â€¹</text>
        </view>
        <view class="month-title">
          <text>{{currentYear}}å¹´{{currentMonth}}æœˆ</text>
        </view>
        <view class="month-nav" bindtap="nextMonth">
          <text class="nav-arrow">â€º</text>
        </view>
        <view class="today-btn" bindtap="goToToday">
          <text>ä»Šå¤©</text>
        </view>
      </view>

      <!-- æ˜ŸæœŸæ ‡é¢˜ -->
      <view class="weekday-row">
        <view class="weekday-cell" wx:for="{{weekDays}}" wx:key="*this">
          <text class="{{index === 0 || index === 6 ? 'weekend' : ''}}">{{item}}</text>
        </view>
      </view>

      <!-- æ—¥æœŸç½‘æ ¼ -->
      <view class="calendar-grid">
        <view 
          class="day-cell {{item.isCurrentMonth ? '' : 'other-month'}} {{item.isToday ? 'today' : ''}} {{item.isPeriod ? 'period' : ''}} {{item.isPredicted ? 'predicted' : ''}} {{item.isStart ? 'period-start' : ''}} {{item.isEnd ? 'period-end' : ''}}"
          wx:for="{{calendarDays}}" 
          wx:key="date"
        >
          <text class="day-num">{{item.day}}</text>
          <view class="day-dot" wx:if="{{item.isPeriod || item.isPredicted}}"></view>
        </view>
      </view>

      <!-- å›¾ä¾‹ -->
      <view class="period-legend">
        <view class="period-legend-item">
          <view class="period-legend-dot period"></view>
          <text>ç»æœŸ</text>
        </view>
        <view class="period-legend-item">
          <view class="period-legend-dot predicted"></view>
          <text>é¢„æµ‹</text>
        </view>
      </view>
    </view>

    <!-- æ“ä½œæŒ‰é’® -->
    <view class="period-action-buttons">
      <button class="period-action-btn primary" bindtap="showRecordStart" wx:if="{{!latestPeriodRecord || latestPeriodRecord.endDate}}">
        <text class="period-btn-icon">ğŸ©¸</text>
        <text>è®°å½•å¼€å§‹</text>
      </button>
      <button class="period-action-btn secondary" bindtap="showRecordEnd" wx:if="{{latestPeriodRecord && !latestPeriodRecord.endDate}}">
        <text class="period-btn-icon">âœ“</text>
        <text>è®°å½•ç»“æŸ</text>
      </button>
      <button class="period-action-btn outline" bindtap="showRecordStart" wx:if="{{latestPeriodRecord && !latestPeriodRecord.endDate}}">
        <text class="period-btn-icon">ğŸ“</text>
        <text>æ–°è®°å½•</text>
      </button>
    </view>

    <!-- å†å²è®°å½•åˆ—è¡¨ -->
    <view class="section-card" wx:if="{{periodRecords.length > 0}}">
      <view class="section-header">
        <view class="section-title-wrap">
          <view class="section-icon">ğŸ“‹</view>
          <text class="section-title">å†å²è®°å½•</text>
        </view>
      </view>
      <view class="period-record-list">
        <view 
          class="period-record-item" 
          wx:for="{{periodRecords}}" 
          wx:key="id"
          bindtap="onPeriodRecordTap"
          data-record="{{item}}"
        >
          <view class="period-record-dates">
            <text class="period-record-start">{{item.startDate.split('T')[0]}}</text>
            <text class="period-record-arrow">â†’</text>
            <text class="period-record-end">{{item.endDate ? item.endDate.split('T')[0] : 'è¿›è¡Œä¸­'}}</text>
          </view>
          <view class="period-record-info">
            <text class="period-record-days" wx:if="{{item.periodDays}}">{{item.periodDays}}å¤©</text>
            <text class="period-record-cycle" wx:if="{{item.cycleDays}}">å‘¨æœŸ{{item.cycleDays}}å¤©</text>
          </view>
        </view>
      </view>
    </view>

    <!-- åº•éƒ¨æ¶ˆæ¯æ¨é€å…¥å£ -->
    <view class="footer-link-wrap">
      <navigator url="/pages/openid/openid" class="footer-link">
        <text class="footer-link-icon">ğŸ””</text>
        <text class="footer-link-text">æ¶ˆæ¯æ¨é€è®¾ç½®</text>
        <text class="footer-link-arrow">â€º</text>
      </navigator>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{!loadingPeriod && periodRecords.length === 0}}">
      <text class="empty-icon">ğŸ“…</text>
      <text class="empty-title">æš‚æ— è®°å½•</text>
      <text class="empty-text">ç‚¹å‡»"è®°å½•å¼€å§‹"æ·»åŠ ç¬¬ä¸€æ¡è®°å½•</text>
    </view>

    <!-- åŠ è½½çŠ¶æ€ -->
    <view class="loading-container" wx:if="{{loadingPeriod}}">
      <view class="loading-spinner"></view>
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>
  </view>

  <view class="safe-bottom"></view>
</view>

<!-- ==================== ä½“é‡è¡¨å•å¼¹çª— ==================== -->
<view class="modal-overlay {{showWeightForm ? 'show' : ''}}" catchtap="hideWeightForm" wx:if="{{showWeightForm}}">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">{{editingWeightId ? 'âœï¸ ç¼–è¾‘è®°å½•' : 'â• æ·»åŠ è®°å½•'}}</text>
      <view class="modal-close" bindtap="hideWeightForm">Ã—</view>
    </view>

    <view class="modal-body" catchtap="stopPropagation">
      <view class="form-group">
        <text class="form-label">ğŸ¾ é€‰æ‹©å®è´</text>
        <view class="person-selector">
          <view 
            class="person-option {{formPersonIndex === index ? 'person-option-active' : ''}}"
            wx:for="{{personList}}"
            wx:key="*this"
            wx:for-item="person"
            data-index="{{index}}"
            bindtap="onPersonSelect"
            style="--person-color: {{personConfig[person].color}}"
          >
            <text class="option-emoji">{{personConfig[person].emoji}}</text>
            <text class="option-name">{{person}}</text>
          </view>
        </view>
      </view>

      <view class="form-group">
        <text class="form-label">âš–ï¸ ä½“é‡ï¼ˆæ–¤ï¼‰</text>
        <view class="input-wrapper">
          <input 
            class="weight-input" 
            type="digit" 
            placeholder="è¯·è¾“å…¥ä½“é‡"
            value="{{formWeight}}"
            bindinput="onWeightInput"
          />
          <text class="input-suffix">æ–¤</text>
        </view>
      </view>

      <view class="form-group">
        <text class="form-label">ğŸ“… è®°å½•æ—¥æœŸ</text>
        <picker mode="date" value="{{formDate}}" bindchange="onWeightDateChange">
          <view class="date-picker">
            <text class="date-value">{{formDate}}</text>
            <text class="picker-arrow">â€º</text>
          </view>
        </picker>
      </view>
    </view>

    <view class="modal-footer">
      <button class="btn btn-secondary" bindtap="hideWeightForm">å–æ¶ˆ</button>
      <button class="btn btn-primary" bindtap="submitWeightForm">ç¡®å®š</button>
    </view>
  </view>
</view>

<!-- ä½“é‡æ“ä½œèœå• -->
<view class="action-overlay {{showWeightActionSheet ? 'show' : ''}}" bindtap="hideWeightActionSheet" wx:if="{{showWeightActionSheet}}">
  <view class="action-sheet" catchtap="">
    <view class="action-header">
      <text class="action-title">{{weightActionSheetPerson}} çš„è®°å½•</text>
    </view>
    <view class="action-item" bindtap="onEditWeightAction">
      <text class="action-icon">âœï¸</text>
      <text class="action-text">ç¼–è¾‘è®°å½•</text>
    </view>
    <view class="action-item action-danger" bindtap="onDeleteWeightAction">
      <text class="action-icon">ğŸ—‘ï¸</text>
      <text class="action-text">åˆ é™¤è®°å½•</text>
    </view>
    <view class="action-cancel" bindtap="hideWeightActionSheet">å–æ¶ˆ</view>
  </view>
</view>

<!-- ==================== å§¨å¦ˆå¼¹çª— ==================== -->
<!-- è®°å½•å¼€å§‹å¼¹çª— -->
<view class="modal-overlay {{showStartModal ? 'show' : ''}}" catchtap="hideStartModal" wx:if="{{showStartModal}}">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">è®°å½•å¼€å§‹æ—¥æœŸ</text>
      <view class="modal-close" bindtap="hideStartModal">Ã—</view>
    </view>
    <view class="modal-body">
      <view class="form-group">
        <text class="form-label">å¼€å§‹æ—¥æœŸ</text>
        <picker mode="date" value="{{startDate}}" bindchange="onStartDateChange">
          <view class="date-picker">
            <text class="date-value">{{startDate}}</text>
            <text class="picker-arrow">â€º</text>
          </view>
        </picker>
      </view>
      <view class="form-group">
        <text class="form-label">å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</text>
        <input class="form-input" placeholder="æ·»åŠ å¤‡æ³¨..." value="{{notes}}" bindinput="onNotesInput" />
      </view>
    </view>
    <view class="modal-footer">
      <button class="btn btn-secondary" bindtap="hideStartModal">å–æ¶ˆ</button>
      <button class="btn btn-primary btn-pink" bindtap="submitStart">ç¡®å®š</button>
    </view>
  </view>
</view>

<!-- è®°å½•ç»“æŸå¼¹çª— -->
<view class="modal-overlay {{showEndModal ? 'show' : ''}}" catchtap="hideEndModal" wx:if="{{showEndModal}}">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">è®°å½•ç»“æŸæ—¥æœŸ</text>
      <view class="modal-close" bindtap="hideEndModal">Ã—</view>
    </view>
    <view class="modal-body">
      <view class="form-group">
        <text class="form-label">ç»“æŸæ—¥æœŸ</text>
        <picker mode="date" value="{{endDate}}" bindchange="onEndDateChange">
          <view class="date-picker">
            <text class="date-value">{{endDate}}</text>
            <text class="picker-arrow">â€º</text>
          </view>
        </picker>
      </view>
    </view>
    <view class="modal-footer">
      <button class="btn btn-secondary" bindtap="hideEndModal">å–æ¶ˆ</button>
      <button class="btn btn-primary btn-pink" bindtap="submitEnd">ç¡®å®š</button>
    </view>
  </view>
</view>

<!-- ç¼–è¾‘å¼¹çª— -->
<view class="modal-overlay {{showPeriodEditModal ? 'show' : ''}}" catchtap="hidePeriodEditModal" wx:if="{{showPeriodEditModal}}">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">ç¼–è¾‘è®°å½•</text>
      <view class="modal-close" bindtap="hidePeriodEditModal">Ã—</view>
    </view>
    <view class="modal-body">
      <view class="form-group">
        <text class="form-label">å¼€å§‹æ—¥æœŸ</text>
        <picker mode="date" value="{{editStartDate}}" bindchange="onEditStartDateChange">
          <view class="date-picker">
            <text class="date-value">{{editStartDate}}</text>
            <text class="picker-arrow">â€º</text>
          </view>
        </picker>
      </view>
      <view class="form-group">
        <text class="form-label">ç»“æŸæ—¥æœŸ</text>
        <picker mode="date" value="{{editEndDate}}" bindchange="onEditEndDateChange">
          <view class="date-picker">
            <text class="date-value">{{editEndDate || 'æœªè®¾ç½®'}}</text>
            <text class="picker-arrow">â€º</text>
          </view>
        </picker>
      </view>
      <view class="form-group">
        <text class="form-label">å¤‡æ³¨</text>
        <input class="form-input" placeholder="æ·»åŠ å¤‡æ³¨..." value="{{editNotes}}" bindinput="onEditNotesInput" />
      </view>
    </view>
    <view class="modal-footer">
      <button class="btn btn-danger" bindtap="deletePeriodRecord">åˆ é™¤</button>
      <button class="btn btn-primary btn-pink" bindtap="submitPeriodEdit">ä¿å­˜</button>
    </view>
  </view>
</view>
