<!-- ä½“é‡è¿½è¸ªé¡µé¢ -->
<view class="container">
  <!-- é¡µé¢å¤´éƒ¨ -->
  <view class="page-header">
    <view class="header-left" bindtap="goBack">
      <text class="back-icon">â€¹</text>
    </view>
    <view class="header-center">
      <text class="page-title">ä½“é‡è¿½è¸ª</text>
      <text class="page-subtitle">è®°å½•æ¯ä¸€å¤©çš„å˜åŒ– ğŸ“Š</text>
    </view>
    <view class="header-right"></view>
  </view>

  <!-- ç»Ÿè®¡å¡ç‰‡ -->
  <view class="stats-grid">
    <view class="stat-card" wx:for="{{personList}}" wx:key="*this" wx:for-item="person">
      <view class="stat-emoji">{{personConfig[person].emoji}}</view>
      <view class="stat-info">
        <text class="stat-name" style="color: {{personConfig[person].color}}">{{person}}</text>
        <text class="stat-value">{{latestWeights[person] || '--'}} <text class="stat-unit">æ–¤</text></text>
      </view>
    </view>
  </view>

  <!-- å›¾è¡¨åŒºåŸŸ -->
  <view class="chart-section">
    <view class="section-header">
      <text class="section-title">ğŸ“ˆ ä½“é‡è¶‹åŠ¿</text>
    </view>
    
    <!-- æ—¶é—´èŒƒå›´ç­›é€‰ -->
    <view class="time-range-tabs">
      <view class="time-tab {{timeRange === 'week' ? 'time-tab-active' : ''}}" 
            bindtap="onTimeRangeChange" data-range="week">è¿‘7å¤©</view>
      <view class="time-tab {{timeRange === 'month' ? 'time-tab-active' : ''}}" 
            bindtap="onTimeRangeChange" data-range="month">è¿‘30å¤©</view>
      <view class="time-tab {{timeRange === '3month' ? 'time-tab-active' : ''}}" 
            bindtap="onTimeRangeChange" data-range="3month">è¿‘3æœˆ</view>
      <view class="time-tab {{timeRange === 'all' ? 'time-tab-active' : ''}}" 
            bindtap="onTimeRangeChange" data-range="all">å…¨éƒ¨</view>
    </view>

    <!-- Canvas æŠ˜çº¿å›¾ -->
    <view class="chart-container">
      <canvas type="2d" id="weight-canvas" class="weight-canvas"></canvas>
    </view>
  </view>

  <!-- è®°å½•åˆ—è¡¨ -->
  <view class="list-section">
    <view class="section-header">
      <text class="section-title">ğŸ“‹ è®°å½•æ˜ç»†</text>
      <view class="add-btn" bindtap="showAddForm">
        <text class="add-btn-icon">+</text>
        <text>æ·»åŠ </text>
      </view>
    </view>

    <!-- åŠ è½½ä¸­ -->
    <view class="loading-container" wx:if="{{loading}}">
      <view class="loading-spinner"></view>
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>

    <!-- æŒ‰äººå‘˜åˆ†ç»„æ˜¾ç¤º -->
    <view class="records-by-person" wx:elif="{{weightRecords.length}}">
      <view class="person-group" wx:for="{{personList}}" wx:key="*this" wx:for-item="person">
        <view class="person-header" wx:if="{{groupedRecords[person].length}}">
          <text class="person-emoji">{{personConfig[person].emoji}}</text>
          <text class="person-name" style="color: {{personConfig[person].color}}">{{person}}</text>
          <text class="person-count">{{groupedRecords[person].length}}æ¡</text>
        </view>
        
        <view class="record-list" wx:if="{{groupedRecords[person].length}}">
          <view 
            class="record-item"
            wx:for="{{groupedRecords[person]}}" 
            wx:key="id"
            wx:for-item="record"
            data-id="{{record.id}}"
            data-person="{{person}}"
            bindtap="onRecordTap"
            bindlongpress="onRecordLongPress"
          >
            <view class="record-date">{{record.recordDateFormatted}}</view>
            <view class="record-weight" style="color: {{personConfig[person].color}}">
              {{record.weight}} <text class="weight-unit">æ–¤</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{!loading && !weightRecords.length}}">
      <text class="empty-icon">âš–ï¸</text>
      <text class="empty-title">è¿˜æ²¡æœ‰ä½“é‡è®°å½•</text>
      <text class="empty-text">ç‚¹å‡»æ·»åŠ æŒ‰é’®ï¼Œå¼€å§‹è®°å½•ä½“é‡</text>
      <view class="empty-btn" bindtap="showAddForm">+ æ·»åŠ è®°å½•</view>
    </view>
  </view>

  <!-- æ·»åŠ /ç¼–è¾‘è¡¨å•å¼¹çª— -->
  <view class="form-overlay {{showForm ? 'show' : ''}}" catchtap="hideForm" wx:if="{{showForm}}">
    <view class="form-popup" catchtap="stopPropagation">
      <view class="form-header">
        <text class="form-title">{{editingId ? 'âœï¸ ç¼–è¾‘è®°å½•' : 'â• æ·»åŠ è®°å½•'}}</text>
        <view class="form-close" bindtap="hideForm">âœ•</view>
      </view>

      <view class="form-body" catchtap="stopPropagation">
        <!-- é€‰æ‹©äººå‘˜ -->
        <view class="form-row">
          <text class="form-label">ğŸ‘¤ é€‰æ‹©äººå‘˜</text>
          <picker mode="selector" range="{{personList}}" value="{{formPersonIndex}}" bindchange="onPersonChange">
            <view class="form-picker">
              <text class="picker-emoji">{{personConfig[personList[formPersonIndex]].emoji}}</text>
              <text class="picker-text">{{personList[formPersonIndex]}}</text>
              <text class="picker-arrow">â–¼</text>
            </view>
          </picker>
        </view>

        <!-- è¾“å…¥ä½“é‡ -->
        <view class="form-row">
          <text class="form-label">âš–ï¸ ä½“é‡ï¼ˆæ–¤ï¼‰</text>
          <view class="form-input-wrap">
            <input 
              class="form-input" 
              type="digit" 
              placeholder="è¯·è¾“å…¥ä½“é‡"
              value="{{formWeight}}"
              bindinput="onWeightInput"
              adjust-position="{{false}}"
              hold-keyboard="{{true}}"
              catchtap=""
            />
            <text class="input-unit">æ–¤</text>
          </view>
        </view>

        <!-- é€‰æ‹©æ—¥æœŸ -->
        <view class="form-row">
          <text class="form-label">ğŸ“… è®°å½•æ—¥æœŸ</text>
          <picker mode="date" value="{{formDate}}" bindchange="onDateChange">
            <view class="form-picker">
              <text class="picker-text">{{formDate}}</text>
              <text class="picker-arrow">â–¼</text>
            </view>
          </picker>
        </view>
      </view>

      <view class="form-footer">
        <button class="form-btn form-btn-cancel" bindtap="hideForm">å–æ¶ˆ</button>
        <button class="form-btn form-btn-submit" bindtap="submitForm">ç¡®å®š</button>
      </view>
    </view>
  </view>

  <!-- æ“ä½œèœå• -->
  <view class="action-sheet-overlay {{showActionSheet ? 'show' : ''}}" bindtap="hideActionSheet" wx:if="{{showActionSheet}}">
    <view class="action-sheet" catchtap="">
      <view class="action-sheet-header">
        <text>{{actionSheetPerson}} çš„ä½“é‡è®°å½•</text>
      </view>
      <view class="action-sheet-item" bindtap="onEditAction">
        <text class="action-icon">âœï¸</text>
        <text>ç¼–è¾‘</text>
      </view>
      <view class="action-sheet-item action-sheet-danger" bindtap="onDeleteAction">
        <text class="action-icon">ğŸ—‘ï¸</text>
        <text>åˆ é™¤</text>
      </view>
      <view class="action-sheet-cancel" bindtap="hideActionSheet">å–æ¶ˆ</view>
    </view>
  </view>

  <!-- æ‚¬æµ®æ·»åŠ æŒ‰é’® -->
  <view class="fab-button" bindtap="showAddForm" wx:if="{{weightRecords.length && !showForm}}">
    <text class="fab-icon">+</text>
  </view>
</view>
