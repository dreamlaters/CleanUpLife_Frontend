<!-- å® ç‰©é¡µé¢ - ä½“é‡è¿½è¸ª -->
<view class="container">
  <!-- è‡ªå®šä¹‰å¯¼èˆªæ  -->
  <view class="custom-navbar" style="padding-top: {{statusBarHeight}}px">
    <view class="navbar-content">
      <text class="navbar-title">æˆ‘çš„å® ç‰©</text>
    </view>
  </view>
  <view class="navbar-placeholder" style="height: {{navbarHeight}}px"></view>

  <!-- å® ç‰©å¡ç‰‡ -->
  <view class="pet-cards">
    <view 
      class="pet-card" 
      wx:for="{{personList}}" 
      wx:key="*this" 
      wx:for-item="person"
      style="--accent-color: {{personConfig[person].color}}"
    >
      <view class="pet-card-accent"></view>
      <view class="pet-avatar">
        <text class="pet-emoji">{{personConfig[person].emoji}}</text>
      </view>
      <view class="pet-info">
        <text class="pet-name">{{person}}</text>
        <view class="pet-weight-wrap">
          <text class="pet-weight">{{latestWeights[person] || '--'}}</text>
          <text class="pet-unit">æ–¤</text>
        </view>
      </view>
    </view>
  </view>

  <!-- å›¾è¡¨åŒºåŸŸ -->
  <view class="section-card">
    <view class="section-header">
      <view class="section-title-wrap">
        <view class="section-icon">ğŸ“ˆ</view>
        <text class="section-title">ä½“é‡è¶‹åŠ¿</text>
      </view>
    </view>
    
    <!-- æ—¶é—´èŒƒå›´ç­›é€‰ -->
    <view class="filter-tabs">
      <view class="filter-tab {{timeRange === 'week' ? 'filter-tab-active' : ''}}" 
            bindtap="onTimeRangeChange" data-range="week">è¿‘7å¤©</view>
      <view class="filter-tab {{timeRange === 'month' ? 'filter-tab-active' : ''}}" 
            bindtap="onTimeRangeChange" data-range="month">è¿‘30å¤©</view>
      <view class="filter-tab {{timeRange === '3month' ? 'filter-tab-active' : ''}}" 
            bindtap="onTimeRangeChange" data-range="3month">è¿‘3æœˆ</view>
      <view class="filter-tab {{timeRange === 'all' ? 'filter-tab-active' : ''}}" 
            bindtap="onTimeRangeChange" data-range="all">å…¨éƒ¨</view>
    </view>

    <!-- Canvas æŠ˜çº¿å›¾ -->
    <view class="chart-wrapper">
      <view class="chart-container" wx:if="{{!showForm}}">
        <canvas type="2d" id="weight-canvas" class="weight-canvas"></canvas>
      </view>
      <view class="chart-container chart-placeholder" wx:else>
        <text class="placeholder-icon">ğŸ“Š</text>
        <text class="placeholder-text">ç¼–è¾‘ä¸­...</text>
      </view>
    </view>

    <!-- å›¾ä¾‹ -->
    <view class="chart-legend">
      <view class="legend-item" wx:for="{{personList}}" wx:key="*this" wx:for-item="person">
        <view class="legend-dot" style="background: {{personConfig[person].color}}"></view>
        <text class="legend-text">{{person}}</text>
      </view>
    </view>
  </view>

  <!-- è®°å½•åˆ—è¡¨ -->
  <view class="section-card">
    <view class="section-header">
      <view class="section-title-wrap">
        <view class="section-icon">ğŸ“‹</view>
        <text class="section-title">è®°å½•æ˜ç»†</text>
      </view>
      <view class="section-badge" wx:if="{{weightRecords.length}}">{{weightRecords.length}}æ¡</view>
    </view>

    <view class="loading-container" wx:if="{{loading}}">
      <view class="loading-spinner"></view>
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>

    <view class="records-container" wx:elif="{{weightRecords.length}}">
      <view class="person-group" wx:for="{{personList}}" wx:key="*this" wx:for-item="person" wx:if="{{groupedRecords[person].length}}">
        <view class="person-header">
          <view class="person-info">
            <text class="person-emoji">{{personConfig[person].emoji}}</text>
            <text class="person-name" style="color: {{personConfig[person].color}}">{{person}}</text>
          </view>
          <view class="person-badge">{{groupedRecords[person].length}}æ¡</view>
        </view>
        
        <view class="record-grid">
          <view 
            class="record-card"
            wx:for="{{groupedRecords[person]}}" 
            wx:key="id"
            wx:for-item="record"
            data-id="{{record.id}}"
            data-person="{{person}}"
            bindtap="onRecordTap"
            bindlongpress="onRecordLongPress"
          >
            <text class="record-date">{{record.recordDateFormatted}}</text>
            <view class="record-value" style="color: {{personConfig[person].color}}">
              <text class="record-weight">{{record.weight}}</text>
              <text class="record-unit">æ–¤</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <view class="empty-state" wx:if="{{!loading && !weightRecords.length}}">
      <text class="empty-icon">âš–ï¸</text>
      <text class="empty-title">è¿˜æ²¡æœ‰ä½“é‡è®°å½•</text>
      <text class="empty-text">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ï¼Œå¼€å§‹è®°å½•å®è´çš„ä½“é‡</text>
      <view class="empty-btn" bindtap="showAddForm">+ æ·»åŠ è®°å½•</view>
    </view>
  </view>

  <!-- æ‚¬æµ®æ·»åŠ æŒ‰é’® -->
  <view class="fab-btn" bindtap="showAddForm" wx:if="{{!showForm}}">
    <text class="fab-icon">+</text>
  </view>

  <!-- åº•éƒ¨æ¶ˆæ¯æ¨é€å…¥å£ -->
  <view class="footer-link-wrap">
    <navigator url="/pages/openid/openid" class="footer-link">
      <text class="footer-link-icon">ğŸ””</text>
      <text class="footer-link-text">æ¶ˆæ¯æ¨é€è®¾ç½®</text>
      <text class="footer-link-arrow">â€º</text>
    </navigator>
  </view>

  <view class="safe-bottom"></view>
</view>

<!-- æ·»åŠ /ç¼–è¾‘è¡¨å•å¼¹çª— -->
<view class="modal-overlay {{showForm ? 'show' : ''}}" catchtap="hideForm" wx:if="{{showForm}}">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">{{editingId ? 'âœï¸ ç¼–è¾‘è®°å½•' : 'â• æ·»åŠ è®°å½•'}}</text>
      <view class="modal-close" bindtap="hideForm">Ã—</view>
    </view>

    <view class="modal-body" catchtap="stopPropagation">
      <!-- é€‰æ‹©å® ç‰© -->
      <view class="form-group">
        <text class="form-label">ğŸ¾ é€‰æ‹©å®è´</text>
        <view class="person-selector">
          <view 
            class="person-option {{formPersonIndex === index ? 'person-option-active' : ''}}"
            wx:for="{{personList}}"
            wx:key="*this"
            wx:for-item="person"
            data-index="{{index}}"
            bindtap="onPersonSelect"
            style="--person-color: {{personConfig[person].color}}"
          >
            <text class="option-emoji">{{personConfig[person].emoji}}</text>
            <text class="option-name">{{person}}</text>
          </view>
        </view>
      </view>

      <!-- è¾“å…¥ä½“é‡ -->
      <view class="form-group">
        <text class="form-label">âš–ï¸ ä½“é‡ï¼ˆæ–¤ï¼‰</text>
        <view class="input-wrapper">
          <input 
            class="weight-input" 
            type="digit" 
            placeholder="è¯·è¾“å…¥ä½“é‡"
            value="{{formWeight}}"
            bindinput="onWeightInput"
          />
          <text class="input-suffix">æ–¤</text>
        </view>
      </view>

      <!-- é€‰æ‹©æ—¥æœŸ -->
      <view class="form-group">
        <text class="form-label">ğŸ“… è®°å½•æ—¥æœŸ</text>
        <picker mode="date" value="{{formDate}}" bindchange="onDateChange">
          <view class="date-picker">
            <text class="date-value">{{formDate}}</text>
            <text class="picker-arrow">â€º</text>
          </view>
        </picker>
      </view>
    </view>

    <view class="modal-footer">
      <button class="btn btn-secondary" bindtap="hideForm">å–æ¶ˆ</button>
      <button class="btn btn-primary" bindtap="submitForm">ç¡®å®š</button>
    </view>
  </view>
</view>

<!-- æ“ä½œèœå• -->
<view class="action-overlay {{showActionSheet ? 'show' : ''}}" bindtap="hideActionSheet" wx:if="{{showActionSheet}}">
  <view class="action-sheet" catchtap="">
    <view class="action-header">
      <text class="action-title">{{actionSheetPerson}} çš„è®°å½•</text>
    </view>
    <view class="action-item" bindtap="onEditAction">
      <text class="action-icon">âœï¸</text>
      <text class="action-text">ç¼–è¾‘è®°å½•</text>
    </view>
    <view class="action-item action-danger" bindtap="onDeleteAction">
      <text class="action-icon">ğŸ—‘ï¸</text>
      <text class="action-text">åˆ é™¤è®°å½•</text>
    </view>
    <view class="action-cancel" bindtap="hideActionSheet">å–æ¶ˆ</view>
  </view>
</view>
