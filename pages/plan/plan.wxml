<!-- è®¡åˆ’é¡µé¢ - å‡ºè¡Œè®¡åˆ’ + å¹´åº¦ç›®æ ‡ -->
<view class="container">
  <!-- è‡ªå®šä¹‰å¯¼èˆªæ  -->
  <view class="custom-navbar" style="padding-top: {{statusBarHeight}}px">
    <view class="navbar-content">
      <text class="navbar-title">æˆ‘çš„è®¡åˆ’</text>
    </view>
  </view>
  <view class="navbar-placeholder" style="height: {{navbarHeight}}px"></view>

  <!-- é¡¶éƒ¨Tabåˆ‡æ¢ -->
  <view class="top-tabs">
    <view class="top-tab {{currentTab === 'travel' ? 'top-tab-active' : ''}}" bindtap="switchTab" data-tab="travel">
      <text class="top-tab-icon">âœˆï¸</text>
      <text class="top-tab-text">å‡ºè¡Œè®¡åˆ’</text>
    </view>
    <view class="top-tab {{currentTab === 'goals' ? 'top-tab-active' : ''}}" bindtap="switchTab" data-tab="goals">
      <text class="top-tab-icon">ğŸ¯</text>
      <text class="top-tab-text">å¹´åº¦ç›®æ ‡</text>
    </view>
  </view>

  <!-- ==================== å‡ºè¡Œè®¡åˆ’å†…å®¹ ==================== -->
  <view class="tab-content" wx:if="{{currentTab === 'travel'}}">
    <!-- å‡ºè¡Œå­Tab -->
    <view class="sub-tabs">
      <view class="sub-tab {{travelTab === 'pending' ? 'sub-tab-active' : ''}}" 
            bindtap="switchTravelTab" data-tab="pending">
        <text>ğŸ—ºï¸ æƒ³å»çš„</text>
        <view class="sub-tab-badge" wx:if="{{pendingCount}}">{{pendingCount}}</view>
      </view>
      <view class="sub-tab {{travelTab === 'visited' ? 'sub-tab-active' : ''}}" 
            bindtap="switchTravelTab" data-tab="visited">
        <text>âœ… å»è¿‡çš„</text>
        <view class="sub-tab-badge" wx:if="{{visitedCount}}">{{visitedCount}}</view>
      </view>
    </view>

    <!-- å‡ºè¡Œåˆ—è¡¨ -->
    <view class="section-card">
      <view class="loading-container" wx:if="{{loadingTravel}}">
        <view class="loading-spinner"></view>
        <text class="loading-text">åŠ è½½ä¸­...</text>
      </view>

      <view class="item-list" wx:elif="{{travelList.length}}">
        <view 
          class="item-card travel-item"
          wx:for="{{travelList}}" 
          wx:key="id"
          data-id="{{item.id}}"
          bindlongpress="showTravelActions"
        >
          <view class="item-emoji">{{item.type === 'Domestic' ? 'ğŸ‡¨ğŸ‡³' : 'ğŸŒ'}}</view>
          <view class="item-content">
            <text class="item-name">{{item.displayName}}</text>
            <view class="item-info">
              <view class="type-badge {{item.type === 'Domestic' ? 'type-domestic' : 'type-international'}}">
                {{item.type === 'Domestic' ? 'å›½å†…' : 'å›½é™…'}}
              </view>
              <text class="priority-text" wx:if="{{travelTab === 'pending'}}">æƒ³å» {{item.priority}}</text>
              <view class="date-badge" wx:if="{{travelTab === 'visited' && item.visitedDateFormatted}}">
                ğŸ“… {{item.visitedDateFormatted}}
              </view>
            </view>
          </view>
          <view class="mark-btn" catchtap="onMarkVisited" data-id="{{item.id}}" wx:if="{{travelTab === 'pending'}}">
            <text>âœ“</text>
          </view>
        </view>
      </view>

      <!-- ç©ºçŠ¶æ€ -->
      <view class="empty-state" wx:if="{{!loadingTravel && !travelList.length}}">
        <text class="empty-icon">{{travelTab === 'pending' ? 'âœˆï¸' : 'ğŸ‰'}}</text>
        <text class="empty-title">{{travelTab === 'pending' ? 'è¿˜æ²¡æœ‰æƒ³å»çš„åœ°æ–¹' : 'è¿˜æ²¡æœ‰å‡ºè¡Œè®°å½•'}}</text>
        <text class="empty-text">{{travelTab === 'pending' ? 'æ·»åŠ ä½ æ¢¦æƒ³ä¸­çš„ç›®çš„åœ°' : 'æŠŠæƒ³å»çš„åœ°æ–¹æ ‡è®°ä¸ºå·²å»è¿‡'}}</text>
        <view class="empty-btn" bindtap="showAddTravelForm" wx:if="{{travelTab === 'pending'}}">+ æ·»åŠ ç›®çš„åœ°</view>
      </view>
    </view>
  </view>

  <!-- ==================== å¹´åº¦ç›®æ ‡å†…å®¹ ==================== -->
  <view class="tab-content" wx:if="{{currentTab === 'goals'}}">
    <!-- å¹´ä»½é€‰æ‹© -->
    <view class="year-selector">
      <picker mode="selector" range="{{goalYearList}}" value="{{goalYearIndex}}" bindchange="onGoalYearChange">
        <view class="year-picker">
          <text class="year-text">{{goalCurrentYear}}å¹´</text>
          <text class="year-arrow">â–¼</text>
        </view>
      </picker>
    </view>

    <!-- åŒæ å¸ƒå±€ -->
    <view class="goal-columns">
      <!-- çŒªçš„ç›®æ ‡ -->
      <view class="goal-column">
        <view class="goal-column-header goal-header-pig">
          <text class="goal-owner-emoji">ğŸ·</text>
          <text class="goal-owner-name">çŒªçš„ç›®æ ‡</text>
        </view>
        
        <view class="goal-list">
          <view 
            class="goal-item {{item.completed ? 'goal-item-completed' : ''}}"
            wx:for="{{goalsPig}}" 
            wx:key="id"
            data-id="{{item.id}}"
            bindlongpress="showGoalActions"
          >
            <view class="goal-checkbox {{item.completed ? 'goal-checkbox-checked' : ''}}" 
                  catchtap="toggleGoalComplete" data-id="{{item.id}}">
              <text wx:if="{{item.completed}}">âœ“</text>
            </view>
            <text class="goal-title {{item.completed ? 'goal-title-completed' : ''}}">{{item.title}}</text>
          </view>
          
          <view class="goal-empty" wx:if="{{!goalsPig.length && !loadingGoals}}">
            <text>æš‚æ— ç›®æ ‡</text>
          </view>
        </view>
        
        <view class="goal-add-btn" bindtap="showAddGoalForm" data-owner="Pig">
          <text class="goal-add-icon">+</text>
          <text>æ·»åŠ </text>
        </view>
      </view>

      <!-- é©´çš„ç›®æ ‡ -->
      <view class="goal-column">
        <view class="goal-column-header goal-header-donkey">
          <text class="goal-owner-emoji">ğŸ«</text>
          <text class="goal-owner-name">é©´çš„ç›®æ ‡</text>
        </view>
        
        <view class="goal-list">
          <view 
            class="goal-item {{item.completed ? 'goal-item-completed' : ''}}"
            wx:for="{{goalsDonkey}}" 
            wx:key="id"
            data-id="{{item.id}}"
            bindlongpress="showGoalActions"
          >
            <view class="goal-checkbox {{item.completed ? 'goal-checkbox-checked' : ''}}" 
                  catchtap="toggleGoalComplete" data-id="{{item.id}}">
              <text wx:if="{{item.completed}}">âœ“</text>
            </view>
            <text class="goal-title {{item.completed ? 'goal-title-completed' : ''}}">{{item.title}}</text>
          </view>
          
          <view class="goal-empty" wx:if="{{!goalsDonkey.length && !loadingGoals}}">
            <text>æš‚æ— ç›®æ ‡</text>
          </view>
        </view>
        
        <view class="goal-add-btn" bindtap="showAddGoalForm" data-owner="Donkey">
          <text class="goal-add-icon">+</text>
          <text>æ·»åŠ </text>
        </view>
      </view>
    </view>

    <!-- åŠ è½½ä¸­ -->
    <view class="loading-container" wx:if="{{loadingGoals}}">
      <view class="loading-spinner"></view>
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>
  </view>

  <!-- æ‚¬æµ®æ·»åŠ æŒ‰é’®ï¼ˆå‡ºè¡Œè®¡åˆ’æ—¶æ˜¾ç¤ºï¼‰ -->
  <view class="fab-btn" bindtap="showAddTravelForm" wx:if="{{currentTab === 'travel' && travelTab === 'pending' && !showTravelForm}}">
    <text class="fab-icon">+</text>
  </view>

  <!-- åº•éƒ¨æ¶ˆæ¯æ¨é€å…¥å£ -->
  <view class="footer-link-wrap">
    <navigator url="/pages/openid/openid" class="footer-link">
      <text class="footer-link-icon">ğŸ””</text>
      <text class="footer-link-text">æ¶ˆæ¯æ¨é€è®¾ç½®</text>
      <text class="footer-link-arrow">â€º</text>
    </navigator>
  </view>

  <view class="safe-bottom"></view>
</view>

<!-- å‡ºè¡Œè¡¨å•å¼¹çª— -->
<view class="modal-overlay {{showTravelForm ? 'show' : ''}}" catchtap="cancelTravelForm" wx:if="{{showTravelForm}}">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">{{editingTravelId ? 'âœ¨ ç¼–è¾‘ç›®çš„åœ°' : 'âœ¨ æ·»åŠ ç›®çš„åœ°'}}</text>
      <view class="modal-close" bindtap="cancelTravelForm">Ã—</view>
    </view>
    
    <view class="modal-body">
      <view class="form-group">
        <text class="form-label">ç›®çš„åœ°ç±»å‹</text>
        <picker mode="selector" range="{{['ğŸ‡¨ğŸ‡³ å›½å†…', 'ğŸŒ å›½å¤–']}}" value="{{travelFormTypeIndex}}" bindchange="onTravelTypeChange">
          <view class="form-picker">
            <text>{{travelFormTypeIndex === 0 ? 'ğŸ‡¨ğŸ‡³ å›½å†…' : 'ğŸŒ å›½å¤–'}}</text>
            <text class="picker-arrow">â–¼</text>
          </view>
        </picker>
      </view>
      
      <!-- å›½å†…é€‰æ‹©çœå¸‚ -->
      <view class="form-group" wx:if="{{travelFormTypeIndex === 0}}">
        <text class="form-label">çœå¸‚</text>
        <picker mode="region" level="city" value="{{travelRegion}}" bindchange="onRegionChange">
          <view class="form-picker">
            <text>{{travelRegionDisplay || 'è¯·é€‰æ‹©çœå¸‚'}}</text>
            <text class="picker-arrow">â–¼</text>
          </view>
        </picker>
      </view>
      
      <!-- å›½å¤–é€‰æ‹©å›½å®¶ -->
      <view class="form-group" wx:if="{{travelFormTypeIndex === 1}}">
        <text class="form-label">å›½å®¶</text>
        <picker mode="selector" range="{{countryList}}" value="{{travelCountryIndex}}" bindchange="onCountryChange">
          <view class="form-picker">
            <text>{{countryList[travelCountryIndex] || 'è¯·é€‰æ‹©å›½å®¶'}}</text>
            <text class="picker-arrow">â–¼</text>
          </view>
        </picker>
      </view>
      
      <view class="form-group">
        <text class="form-label">å¤‡æ³¨åç§°</text>
        <input class="form-input" placeholder="å¯é€‰ï¼Œå¦‚ï¼šè¿ªå£«å°¼" value="{{travelFormName}}" bindinput="onTravelNameInput" />
      </view>
      
      <view class="form-group">
        <text class="form-label">æƒ³å»ç¨‹åº¦ (1-30)</text>
        <slider min="1" max="30" value="{{travelFormPriority}}" show-value="true" 
                activeColor="#667eea" block-color="#667eea" bindchange="onTravelPriorityChange" />
      </view>
    </view>
    
    <view class="modal-footer">
      <button class="btn btn-secondary" bindtap="cancelTravelForm">å–æ¶ˆ</button>
      <button class="btn btn-primary" bindtap="submitTravelForm">ç¡®å®š</button>
    </view>
  </view>
</view>

<!-- ç›®æ ‡è¡¨å•å¼¹çª— -->
<view class="modal-overlay {{showGoalForm ? 'show' : ''}}" catchtap="hideGoalForm" wx:if="{{showGoalForm}}">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">{{editingGoalId ? (goalFormOwner === 'Pig' ? 'ğŸ· ç¼–è¾‘ç›®æ ‡' : 'ğŸ« ç¼–è¾‘ç›®æ ‡') : (goalFormOwner === 'Pig' ? 'ğŸ· æ–°ç›®æ ‡' : 'ğŸ« æ–°ç›®æ ‡')}}</text>
      <view class="modal-close" bindtap="hideGoalForm">Ã—</view>
    </view>
    
    <view class="modal-body">
      <view class="form-group">
        <text class="form-label">ğŸ“… ç›®æ ‡å¹´ä»½</text>
        <picker mode="selector" range="{{goalFormYearList}}" value="{{goalFormYearIndex}}" bindchange="onGoalFormYearChange">
          <view class="form-picker">
            <text>{{goalFormYear}}å¹´</text>
            <text class="picker-arrow">â–¼</text>
          </view>
        </picker>
      </view>
      
      <view class="form-group">
        <text class="form-label">ğŸ¯ ç›®æ ‡å†…å®¹</text>
        <input class="form-input" placeholder="è¾“å…¥ä½ çš„å¹´åº¦ç›®æ ‡..." value="{{goalFormTitle}}" bindinput="onGoalTitleInput" />
      </view>
    </view>
    
    <view class="modal-footer">
      <button class="btn btn-secondary" bindtap="hideGoalForm">å–æ¶ˆ</button>
      <button class="btn btn-primary" bindtap="submitGoalForm">ç¡®å®š</button>
    </view>
  </view>
</view>

<!-- æ“ä½œèœå• -->
<view class="action-sheet-mask {{showActionSheet ? 'show' : ''}}" bindtap="hideActionSheet" wx:if="{{showActionSheet}}">
  <view class="action-sheet {{showActionSheet ? 'show' : ''}}" catchtap="">
    <view class="action-sheet-header">
      <text class="action-sheet-title">{{actionSheetTitle}}</text>
    </view>
    <view class="action-sheet-item" bindtap="onActionEdit">
      <text>âœï¸</text>
      <text>ç¼–è¾‘</text>
    </view>
    <view class="action-sheet-item action-sheet-item-danger" bindtap="onActionDelete">
      <text>ğŸ—‘ï¸</text>
      <text>åˆ é™¤</text>
    </view>
    <view class="action-sheet-item action-sheet-cancel" bindtap="hideActionSheet">å–æ¶ˆ</view>
  </view>
</view>
